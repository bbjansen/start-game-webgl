<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'>
		<title>discover</title>
		<style>
			body { margin: 0; }


		</style>
	</head>
	<body>
    	<script src='./assets/js/colyseus.js'></script>
		<script src='./assets/js/three.js'></script>
		<script src='./assets/js/three/OrbitControls.js'></script>


		<script>
            let client, world, width, height, camera, controls, scene, renderer;
            
            // Set Server
            client = new Colyseus.Client('ws://139.162.170.247:2567');

            // Set frame
            width = window.innerWidth
            height = window.innerHeight

            // Load Font
            let font;
            const loader = new THREE.FontLoader();
            loader.load('./assets/fonts/helvetiker_regular.typeface.json', function ( response ) {
                font = response;
            } );

            // Go!
            init()
            animate()

            function init() {
        
                // Generate Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color( 0x161616 );
                scene.fog = new THREE.FogExp2( 0x161616, 0.02 );

                // Render
                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( width, height );
                document.body.appendChild( renderer.domElement );

                // Camera and Controls
                camera = new THREE.PerspectiveCamera( 60, width / height, 0.5, 1000);
                controls = new THREE.OrbitControls( camera, renderer.domElement );

                camera.position.set( 1, 5, 15 );
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.screenSpacePanning = false;
                controls.minDistance = 0;
                controls.maxDistance = 50;

                controls.maxPolarAngle = Math.PI / 2
            
                // Generate Shading
				const NorthLight = new THREE.DirectionalLight( 0xffffff );
				NorthLight.position.set( 1, 1, 1 );
				scene.add( NorthLight );

				const SouthLight = new THREE.DirectionalLight( 0x002288 );
				SouthLight.position.set( - 1, - 1, - 1 );
				scene.add( SouthLight );

				const ambientLight = new THREE.AmbientLight( 0x222222 );
				scene.add( ambientLight );

                // Add logged in Players
                client.joinOrCreate('world').then(instance => {
                    room = instance

                    var players = {};
                    var colors = [0xff0000, 0x00ff00, 0xffff00, 0x0000ff, 0x00ffff, 0x9900ff];

                    // New player enters the world
                    room.state.players.onAdd = function (player, sessionId) {

                        // Lets generate the Player object
                        const cylinder = new THREE.CylinderBufferGeometry(0, 1, 3, 5, 1);
                        const cylinderMaterial = new THREE.MeshPhongMaterial( { color: colors[Math.floor(Math.random() * colors.length)],  flatShading: true } );

                        let Player = new THREE.Mesh(cylinder, cylinderMaterial )
                        
                        // Generate a label for the Player
                        const label = new THREE.TextGeometry(sessionId, {
                            font: font,
                            size: 0.2,
                            height: 0.05,
                            curveSegments: 0.1,
                            bevelEnabled: false,
                            bevelThickness: 0.1,
                            bevelSize: 0.1,
                            bevelSegments: 0.1
                        });

                        // Add the Player's nametag
                        const textMaterial = new THREE.MeshBasicMaterial({ color: colors[Math.floor(Math.random() * colors.length)] });
                        var playerName = new THREE.Mesh(label, textMaterial);

                        playerName.position.z = 0;
                        playerName.position.x = -0.7;
                        playerName.position.y = 2.5;
                        playerName.rotation.y = 0;

                        Player.add(playerName);

                        // Update the Player's coordinates onchange
                        player.onChange = function (changes) {
                            Player.position.x = player.x;
                            Player.position.z = player.y;
                        }
            
                        // Add the Player to the Scene
                        players[sessionId] = Player;
                        scene.add(Player); 
                    }

                    // Remove the Player from the Scene on leavicng
                    room.state.players.onRemove = function (player, sessionId) {
                        scene.remove(players[sessionId]);
                        delete players[sessionId];
                    }

                    room.onMessage('hello', (message) => {
                        console.log(message);
                    });
                });

                window.addEventListener( 'resize', onWindowResize, false );
            };

            // Resize

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize( window.innerWidth, window.innerHeight );
            }


            // Movement Keys
            document.addEventListener('keydown', onDocumentKeyDown, false);

            function onDocumentKeyDown(event) {

                var keyCode = event.which;

                if (keyCode == 40) {
                    room.send('move', { y: 1 })
                } 
                
                if (keyCode == 38) {
                    room.send('move', { y: -1 });
                } 
                
                if (keyCode == 37) {
                    room.send('move', { x: -1 })
                } 
                
                if (keyCode == 39) {
                    room.send('move', { x: 1 });
                }
            };

            // Animate
            function animate() {
                requestAnimationFrame( animate );
                controls.update();
                render();
            }

            function render() {
                renderer.render( scene, camera );
            }
		</script>
	</body>
</html>